<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤怠データ変換ツール</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007cba;
            color: white;
            border: none;
            cursor: pointer;
        }
        .output {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>勤怠データ変換ツール</h1>
    
    <h2>入力データ</h2>
    <textarea id="input" placeholder="PowerAppsのHTMLソースまたはテキストデータを貼り付けてください（貼り付けると自動変換されます）">25	(日)		テレ1日	20:49	テレ終了	21:53
26	(月)		出勤	9:10	退勤	19:57	9:30</textarea>
    
    <button onclick="convert()">変換</button>
    <button onclick="clear_all()">クリア</button>
    
    <h2>変換結果</h2>
    <div class="output" id="output">ここに変換結果が表示されます</div>
    
    <button onclick="copy_result()" id="copyBtn" style="display:none;">結果をコピー</button>

    <script>
        // 自動変換の設定
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('input');
            
            // 貼り付け時に自動実行
            input.addEventListener('paste', function() {
                setTimeout(() => {
                    convert();
                }, 100); // 貼り付け処理完了後に実行
            });
            
            // 入力変更時も自動実行（タイピングの場合）
            let timeout;
            input.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    if (input.value.trim().length > 10) {
                        convert();
                    }
                }, 500); // 0.5秒後に実行
            });
        });

        function convert() {
            const input = document.getElementById('input').value;
            if (!input.trim()) {
                alert('データを入力してください');
                return;
            }
            
            console.log('変換開始');
            
            try {
                const data = parse_data(input);
                console.log('パース結果:', data);
                
                if (data.length === 0) {
                    document.getElementById('output').textContent = 'データが見つかりませんでした';
                    return;
                }
                
                const csv = generate_csv(data);
                document.getElementById('output').textContent = csv;
                document.getElementById('copyBtn').style.display = 'inline-block';
                
                console.log('変換完了:', data.length + '件');
                
            } catch (error) {
                console.error('エラー:', error);
                document.getElementById('output').textContent = 'エラー: ' + error.message;
            }
        }
        
        function parse_data(input) {
            const data = [];
            
            // HTMLの場合、テキストのみを抽出
            let text = input;
            if (input.includes('<') && input.includes('>')) {
                const div = document.createElement('div');
                div.innerHTML = input;
                text = div.textContent || div.innerText || '';
            }
            
            console.log('処理するテキスト長:', text.length);
            
            const lines = text.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // 日付パターンを検索
                const dateMatch = line.match(/(\d{1,2})\s*[\(（]([^）\)]+)[\)）]/);
                if (dateMatch) {
                    const day = dateMatch[1];
                    const dayOfWeek = dateMatch[2];
                    
                    // 同じ行または次の行から詳細を抽出
                    let fullLine = line;
                    if (i + 1 < lines.length) {
                        fullLine += ' ' + lines[i + 1];
                    }
                    if (i + 2 < lines.length) {
                        fullLine += ' ' + lines[i + 2];
                    }
                    
                    // 時刻を抽出
                    const times = fullLine.match(/\d{1,2}:\d{2}/g) || [];
                    
                    // 勤務タイプを抽出
                    let startType = '';
                    let endType = '';
                    
                    if (fullLine.includes('テレ1日')) startType = 'テレ1日';
                    else if (fullLine.includes('テレ2h')) startType = 'テレ2h';
                    else if (fullLine.includes('出勤')) startType = '出勤';
                    
                    if (fullLine.includes('テレ終了')) endType = 'テレ終了';
                    else if (fullLine.includes('退勤')) endType = '退勤';
                    
                    const entry = {
                        day: day,
                        dayOfWeek: dayOfWeek,
                        startType: startType,
                        startTime: times[0] || '',
                        endType: endType,
                        endTime: times[1] || '',
                        workHours: times[2] || ''
                    };
                    
                    data.push(entry);
                    console.log(day + '日:', entry);
                }
            }
            
            return data;
        }
        
        function generate_csv(data) {
            let csv = '日付\t曜日\t出勤区分\t出勤時刻\t退勤区分\t退勤時刻\t勤務時間\n';
            
            data.forEach(row => {
                csv += [
                    row.day,
                    row.dayOfWeek,
                    row.startType,
                    row.startTime,
                    row.endType,
                    row.endTime,
                    row.workHours
                ].join('\t') + '\n';
            });
            
            return csv;
        }
        
        function copy_result() {
            const output = document.getElementById('output').textContent;
            navigator.clipboard.writeText(output).then(() => {
                alert('コピーしました');
            }).catch(() => {
                // フォールバック
                const textarea = document.createElement('textarea');
                textarea.value = output;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('コピーしました');
            });
        }
        
        function clear_all() {
            document.getElementById('input').value = '';
            document.getElementById('output').textContent = 'ここに変換結果が表示されます';
            document.getElementById('copyBtn').style.display = 'none';
        }
    </script>
</body>
</html>